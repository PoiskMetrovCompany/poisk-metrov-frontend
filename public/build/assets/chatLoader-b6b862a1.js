var y=Object.defineProperty;var M=(l,e,t)=>e in l?y(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var a=(l,e,t)=>(M(l,typeof e!="symbol"?e+"":e,t),t);import{i as w}from"./isMobile-f1446475.js";import{a as u}from"./axios-1779699b.js";import{C as g}from"./CRMForm-b29a7dfb.js";import"./name-7cec568d.js";const F=["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"],C=["Января","Февраля","Марта","Апреля","Мая","Июня","Июля","Августа","Сентября","Октября","Ноября","Декабря"];class T{constructor(e){a(this,"chatWindow");a(this,"inputForm");a(this,"textArea");a(this,"messageContainer");a(this,"callForm");a(this,"callForApartments");a(this,"callButton");a(this,"defaultWindowClass");a(this,"clientMessageTemplate");a(this,"managerMessageTemplate");a(this,"agentMessageTemplate");a(this,"dateMessageTemplate");a(this,"funnelMessageTemplate");a(this,"hasManagerMessage",!1);a(this,"tooLongNotified",!1);a(this,"lastSentTimer");a(this,"crmForm");a(this,"crmApartmentsForm");a(this,"chatCategory","expert");a(this,"chatTopic");a(this,"hasChatToken");a(this,"token");a(this,"channel","manager-message");a(this,"channelEvent",".messaged");a(this,"finalMessage","Мы уже подготовили для вас предложение, напишите ваш номер WhatsApp. Оставьте номер телефона к которому привязан мессенджер и эксперт отправит вам всю информацию в ближайшее время");a(this,"sentMessages",[]);a(this,"datesInHistory",[]);a(this,"questionsFunnel",{"Квартиры для инвестиций":{"Выберите ценовой диапазон":{"до 5 млн. рублей":this.finalMessage,"до 10 млн. рублей":this.finalMessage,"до 15 млн. рублей":this.finalMessage}},"Квартиры для проживания":{"Выберите ценовой диапазон":{"до 5 млн. рублей":this.finalMessage,"до 10 млн. рублей":this.finalMessage,"до 15 млн. рублей":this.finalMessage}}});a(this,"currentFunnel",this.questionsFunnel);a(this,"userSelections",[]);this.chatWindow=e,this.defaultWindowClass=this.chatWindow.className,this.messageContainer=this.chatWindow.querySelector(".message-container"),this.chatWindow.querySelector(".chat-window.close").onclick=()=>this.hide(),this.chatWindow.querySelector(".arrow-chevron-right").onclick=()=>this.hide(),this.callForm=document.getElementById("call-from-chat"),this.callForApartments=document.getElementById("call-for-apartments"),this.callButton=document.getElementById("chat-quick-call-button"),this.callForm.querySelector(".chat-window.close").onclick=()=>this.callForm.className=this.callForm.className.replace(" shown",""),this.inputForm=this.chatWindow.querySelector("form.chat-window.form"),this.inputForm.onsubmit=s=>this.onSubmit(s),this.callButton.onclick=()=>{this.callForm.querySelectorAll(".peinag.checkbox").forEach(s=>s.checked=!0),this.crmForm.onSubmit(new Event("submit"))},this.textArea=this.inputForm.querySelector("textarea"),this.textArea.addEventListener("keyup",()=>{this.updateTextArea(),this.validateInputForm()});let t=!1;this.textArea.addEventListener("keydown",({key:s})=>{s==="Shift"&&(t=!0)}),this.textArea.addEventListener("keyup",({key:s})=>{s==="Shift"&&(t=!1),s==="Enter"&&!t&&this.submitMessage(this.inputForm)}),this.textArea.focus(),this.updateTextArea(),this.validateInputForm(),this.loadMessages(),this.loadFunnel()}async loadMessages(){this.loadMessageTemplates(),await this.getChatToken(),await this.loadChatHistory(),this.datesInHistory.includes("Сегодня")||this.createDateMessage("Сегодня")}loadCallForm(){this.crmForm=new g("call-from-chat",void 0,"/api/leave-request",["name","phone"],()=>`\r
Запрос на звонок из чата\r
\r
Сообщения:\r
`+this.sentMessages.join(`\r
\r
`),()=>{this.createAgentMessage("Ваша заявка успешно отправлена. Ожидайте звонка специалиста."),this.callForm.style.display="none",this.callButton.style.display="none"},()=>{this.createAgentMessage("Ошибка при отправке заявки."),this.callForm.style.display="none",this.callButton.style.display="none"})}loadCallForApartmentsForm(){this.crmApartmentsForm=new g("call-for-apartments",void 0,"/api/leave-request",["name","phone"],()=>`\r
Написать в Whatsapp \r
Интересует: `+this.userSelections.join(" "),()=>{this.createAgentMessage("Ваша заявка успешно отправлена."),this.callForApartments.style.display="none"},()=>{this.createAgentMessage("Ошибка при отправке заявки."),this.callForApartments.style.display="none"})}containsNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}isFormValid(){return this.textArea.value.trim().length>0}validateInputForm(){this.inputForm.className=this.isFormValid()?"chat-window form":"chat-window form invalid"}loadMessageTemplates(){const e=Array.from(document.getElementById("chat-message-templates").children);this.clientMessageTemplate=e[0],this.managerMessageTemplate=e[1],this.agentMessageTemplate=e[2],this.dateMessageTemplate=e[3],this.funnelMessageTemplate=e[4]}createClientMessage(e){const t=this.createMessageFromTemplate(this.clientMessageTemplate),s=t.querySelector(".message.text-container").children[0];return s.textContent=e,t}createManagerMessage(e,t,s){const n=this.createMessageFromTemplate(this.managerMessageTemplate),i=n.querySelector(".message.reciever.name-and-text").children,r=i[0];r.textContent=e;const o=i[1];o.textContent=t;const c=n.querySelector("img");if(s!=""&&s!=null&&s!="null")c.src=s;else{c.style.display="none";const m=n.querySelector(".message.site-logo-as-icon");m.style.display="grid"}return n}createAgentMessage(e){const t=this.createMessageFromTemplate(this.agentMessageTemplate),n=t.querySelector(".message.reciever.name-and-text").children[1];return n.textContent=e,t}createDateMessage(e){const t=this.createMessageFromTemplate(this.dateMessageTemplate);return t.textContent=e,t}loadFunnel(){const e=this.chatWindow.querySelector(".chat-window.funnel"),t=Object.keys(this.questionsFunnel);Array.from(e.children).forEach((s,n)=>{s.addEventListener("click",()=>{this.createClientMessage(t[n]),this.userSelections.push(s.textContent.trim()),Object.keys(this.questionsFunnel[t[n]]).forEach(i=>{this.createAgentMessage(i);const r=Object.keys(this.questionsFunnel[t[n]][i]);this.currentFunnel=this.questionsFunnel[t[n]][i],this.createFunnelStartMessages(r)}),e.remove()})})}createFunnelStartMessages(e){const t=this.createMessageFromTemplate(this.funnelMessageTemplate),s=t.querySelector(".chat-window.category-button"),n=[],i="chat-window category-button";return e.forEach(r=>{const o=s.cloneNode(!0);o.textContent=r,o.onclick=()=>{t.style.pointerEvents="none",t.style.opacity="0.5",n.forEach(c=>c.className=i),o.className+=" selected",this.currentFunnel=this.currentFunnel[o.textContent],this.userSelections.push(r),typeof this.currentFunnel=="string"&&(this.createAgentMessage(this.currentFunnel),this.callForApartments.className+=" shown",this.loadCallForApartmentsForm())},t.appendChild(o),n.push(n)}),s.remove(),t}createMessageFromTemplate(e){const t=e.cloneNode(!0);return this.messageContainer.appendChild(t),this.setTimeOnMessage(t),setTimeout(()=>{this.messageContainer.scrollTo({left:0,top:this.messageContainer.scrollHeight,behavior:"smooth"})},100),t}setTimeOnMessage(e,t=null){const s=e.querySelector(".message.time");if(s)if(t==null){const n=new Date;let i=n.getMinutes();i<10&&(i=`0${i}`),s.textContent=n.getHours()+":"+i}else s.textContent=t}updateTextArea(){this.textArea.style.height="1px",this.textArea.style.height=this.textArea.scrollHeight+"px",this.textArea.style.borderRadius=this.textArea.scrollHeight<30?"24px":"16px"}async getChatToken(){const e=await u.get("/api/chat-token");e.status==200?(this.hasChatToken=e.data.hasToken,this.token=e.data.token,window.Echo.channel(`${this.channel}.${this.token}`).listen(this.channelEvent,t=>this.onMessageRecieved(t))):await this.getChatToken()}async loadChatHistory(){const e=await u.get("/api/chat-history");let t;e.data.history.forEach(s=>{let n;const i=new Date(s.created_at),r=new Date;if(!t||t.getDate()!=i.getDate()){t=i;const m=t.getDay(),d=t.getDate(),p=t.getMonth(),f=t.getFullYear().toString();let h=`${F[m]} ${d} ${C[p]} ${f}`;switch(r.getDate()-t.getDate()){case 0:h="Сегодня";break;case 1:h="Вчера";break;case 2:h="Позавчера";break}this.datesInHistory.push(h),this.createDateMessage(h)}let o=i.getMinutes();o<10&&(o=`0${o}`);const c=i.getHours()+":"+o;s.author=="user"&&(n=this.createClientMessage(s.message)),s.author=="manager"&&(n=this.createManagerMessage(s.authorName,s.message,s.profilePic)),n&&this.setTimeOnMessage(n,c)})}isLastMessageByManager(){this.messageContainer.lastChild.className.includes("reciever")}setCategoryFromButton(e){this.chatCategory=e.id}onMessageRecieved(e){this.hasManagerMessage=!0,this.createManagerMessage(e.managerName,e.message,e.managerProfilePic)}async submitMessage(e){if(!this.isFormValid())return;const t=new FormData(e);t.set("chatCategory",this.chatCategory);const s=this.createClientMessage(t.get("message"));s.style.opacity=.5,s.style.pointerEvents="none",this.sentMessages.push(this.textArea.value),this.textArea.value="",this.validateInputForm(),this.updateTextArea(),await u.post("/api/send-chat-message",t),this.lastSentTimer&&clearTimeout(this.lastSentTimer),this.lastSentTimer=setTimeout(()=>{this.weWillCallLater()},60*1*1e3),s.style.opacity=1,s.style.pointerEvents="initial";const n=new Date;if(n.getHours()<10||n.getHours()>=21){let i="Наши операторы работают с 10:00 до 21:00. Оставьте свои контактные данные и с вами обязательно свяжутся.";isUserAuthorized&&(i="Наши операторы работают с 10:00 до 21:00. Оставьте свои контактные данные и с вами обязательно свяжутся."),this.weWillCallLater(i)}}weWillCallLater(e=null){this.tooLongNotified||this.isLastMessageByManager()||this.hasManagerMessage||(this.tooLongNotified=!0,isUserAuthorized?this.callButton.style.display="grid":this.callForm.className+=" shown",e==null?isUserAuthorized?this.createAgentMessage("Сейчас все специалисты заняты. Нажмите кнопку «Перезвоните мне» и наш специалист перезвонит вам в ближайшее время."):this.createAgentMessage("Сейчас все специалисты заняты. Заполните форму заявки и наш специалист перезвонит вам в ближайшее время."):this.createAgentMessage(e),this.loadCallForm())}async onSubmit(e){e.preventDefault(),this.hasChatToken&&await this.submitMessage(e.target)}switch(){this.chatWindow.className==this.defaultWindowClass?this.show():this.hide()}show(){this.chatWindow.className.includes(" shown")||(this.chatWindow.className+=" shown")}hide(){this.chatWindow.className=this.defaultWindowClass,sessionStorage.setItem("chatWasClosed",!0)}}document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("open-chat-button"),e=document.querySelector(".chat-window.base-container"),t=new T(e),s=w(),n=new Boolean(sessionStorage.getItem("chatWasClosed")).valueOf();let i=!1;l.addEventListener("click",()=>{t.switch(),i=!0});const r=1,o=60,c=1e3;setTimeout(()=>{!i&&!s&&n!=!0&&t.show()},r*o*c)});
